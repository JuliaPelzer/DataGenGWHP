# Tutorial for VampireMan

This guide will show you how to use the software.
It assumes, you have already installed PFLOTRAN, VampireMan, and all dependencies on your system.
Double check by running `python3 -m vampireman --help` in the top level directory and if it doesn't show something similar to the following screenshot, consult the [README](../README.md#installation-of-the-software).

![Help output of VampireMan](./img/help-output.png)

First, we'll create an input file.
You can have a look at [case 10](../settings/case10_all-features.yaml), it shows all possible values that can be set.

For an easy configuration, we'll use the following setting and save it to `example.yaml` (the file can also be found in this directory):

```yaml
# Basic setting with
# - one fix heat pump
# - two generated heat pumps,
# - two data points
# - interactive mode
# - mpirun with as many processors as the system has
# - spatially varying permeability field
# - constant temperature, in one dp its 8 and in the other 10 degrees celsius

general:
  number_cells: [32, 256, 1]
  cell_resolution: 5.0 # this is the default, so it could be left out
  interactive: true # this is the default, so it could be left out
  output_directory: ./datasets_out/example
  number_datapoints: 2
  mpirun_procs: null # default would be 1
heatpump_parameters:
  hp1:
    vary: fixed
    value:
      location: [16, 32, 1]
      injection_temp: 15
      injection_rate: 0.00024
  hps:
    vary: spatially_vary_within_datapoint
    value:
      number: 2
      injection_temp:
        min: 12
        max: 14
      injection_rate:
        min: 0.00002
        max: 0.0002
hydrogeological_parameters:
  permeability:
    vary: spatially_vary_within_datapoint
    distribution: logarithmic
    value:
      frequency: [18, 18, 18]
      max: 5.1e-09
      min: 1.02e-11
  temperature:
    vary: const_within_datapoint
    value:
      min: 8
      max: 10
```

Now you can run `python3 -m vampireman --settings-file example.yaml`.
You should see this output:

![Output when running the example.yaml config](./img/example-setting.png)

This output is a representation of what the merged configuration, the defaults of the software which are overlaid with the user settings from the `example.yaml` file, looks like.

VampireMan asks you "Do you want to run the variation stage? Y/n", which you can answer with pressing enter.
Only when you type in "N" or "n" and press enter, the program will count the answer as being negative, everything else will be a positive answer.

The variation of the parameters happens quite fast for this example and should look exactly like this (as everything should be reproducible):

![Output after the variation stage](./img/variation.png)

Then, when we continue by hitting the enter key, the render stage produces the PFLOTRAN input files in this structure:

```
datasets_out/example
├── datapoint-0
│   ├── datapoint.json
│   ├── permeability_field.h5
│   └── pflotran.in
├── datapoint-1
│   ├── datapoint.json
│   ├── permeability_field.h5
│   └── pflotran.in
├── east.ex
├── mesh.uge
├── north.ex
├── south.ex
├── state.json
└── west.ex
```

You can look at the `mesh.uge`, `east.ex`, ..., `pflotran.in` files to see the rendered results.
Also, you can take a look at the `state.json` and `datapoint.json` files.
These are serialized versions of the state and data points.
This is useful for later information retrieval.

When continuing with the simulation stage, you should see the simulation output of PFLOTRAN which looks like this:

![PFLOTRAN output](./img/pflotran.png)

The final stage, visualization, plots images from the `pflotran.h5` files (generated by PFLOTRAN during the simulation stage) into their data point directories.
They should look like this:

![](./img/permeability_field.png)
![](./img/Pflotran_isolines.jpg)
![](./img/Pflotran_properties_2d.jpg)

Now you have a complete data set, consisting of the inputs (in the form of the `.h5`, `.uge`, `.ex`, and `.json` files) and outputs (in the form of `pflotran.out` and the images).

When you run the program again, the simulation files will remain in the directories and VampireMan will detect them.
You'll be asked if you want to skip the simulation or re-run it.

You can also set `interactive: false` in the configs `general` section or run the program with `python3 -m vampireman --non-interactive --settings-file ./example.yaml` to run in non-interactive mode.
This mode implicitly answers all questions with "yes".

This concludes the tutorial.
