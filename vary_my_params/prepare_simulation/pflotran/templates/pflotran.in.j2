#Description: flow in a 3D area plus one heatpump - super super simplified for approach 2 try 1

SIMULATION
  SIMULATION_TYPE SUBSURFACE
  PROCESS_MODELS
    SUBSURFACE_FLOW flow
      MODE TH
    /
  /
END

SUBSURFACE

#=========================== times ============================================

  TIME
    FINAL_TIME {{ time_to_simulate.final_time }} {{ time_to_simulate.unit }}
    MAXIMUM_TIMESTEP_SIZE 1.0 year
  END

  REFERENCE_PRESSURE 101325. #[Pa]

#=========================== solver options ===================================

  #NEWTON_SOLVER FLOW
  #  ITOL_UPDATE 1.d0     ! Convergences with max change in pressure is 1 Pa.
  #END

  NUMERICAL_METHODS FLOW
    NEWTON_SOLVER
      ANALYTICAL_JACOBIAN
      ITOL_UPDATE 10.d0
      RTOL 1.d-3
    /
    LINEAR_SOLVER
      SOLVER ITERATIVE
    /
  END

#=========================== fluid properties =================================

  FLUID_PROPERTY
    DIFFUSION_COEFFICIENT 1.d-9 #[m^2/s] #checked
  END

  DATASET perm
    HDF5_DATASET_NAME Permeability
    FILENAME permeability_field.h5
  END

#=========================== material properties ==============================

  MATERIAL_PROPERTY gravel
    ID 1
    POROSITY 0.25d0                     #[-]
    ROCK_DENSITY 2.8d3                  #[kg/m^3]
    SPECIFIC_HEAT 2.0d3                 #of rock? [J/(kg*K)]
    THERMAL_CONDUCTIVITY_DRY 0.65       #[W/(K*m)] #TODO check
    THERMAL_CONDUCTIVITY_WET 1.0        #[W/(K*m)] #TODO check
    LONGITUDINAL_DISPERSIVITY 1.0       #[m]
    TRANSVERSE_DISPERSIVITY_H 0.1       #[m]
    PERMEABILITY                        #[m^2] #TESTCASE
      DATASET perm
      {%- if vertical_anisotropy_ratio %}
      {#- what about PERM_ISO here? https://www.pflotran.org/documentation/user_guide/cards/subsurface/material_property_card.html #}
      VERTICAL_ANISOTROPY_RATIO {{ vertical_anisotropy_ratio.value }}
      {%- endif %}
    /
    CHARACTERISTIC_CURVES cc1
  END

  {% for heatpump in heatpumps -%}
  {% set outer_loop = loop -%}
  {% for key, value in heatpump.items() -%}
  MATERIAL_PROPERTY {{ key }}_material
    ID {{ outer_loop.index + 5 + 1 }} {#- The + 5 part is for visually separating the heatpumps from the gravel material, the + 1 is for starting at 2 as gravel already has id 1 #}
    POROSITY 0.25d0                     #[-]
    ROCK_DENSITY 2.8d3                  #[kg/m^3]
    SPECIFIC_HEAT 2.0d3                 #of rock? [J/(kg*K)]
    THERMAL_CONDUCTIVITY_DRY 0.65       #[W/(K*m)] #TODO check
    THERMAL_CONDUCTIVITY_WET 1.0        #[W/(K*m)] #TODO check
    LONGITUDINAL_DISPERSIVITY 1.0       #[m]
    TRANSVERSE_DISPERSIVITY_H 0.1       #[m]
    PERMEABILITY                        #[m^2] #TESTCASE
      PERM_ISO 5.09683995922528e-09 # Maybe this might be too high?
    /
    CHARACTERISTIC_CURVES cc1
  END

  {% endfor %}
  {%- endfor %}

#=========================== characteristic curves ============================

  CHARACTERISTIC_CURVES cc1
    SATURATION_FUNCTION VAN_GENUCHTEN
      ALPHA  1.d-4
      M 0.5d0
      LIQUID_RESIDUAL_SATURATION 0.1d0
    /
    PERMEABILITY_FUNCTION MUALEM_VG_LIQ
      M 0.5d0
      LIQUID_RESIDUAL_SATURATION 0.1d0
    /
  END

#=========================== discretization ===================================

  GRID
    TYPE UNSTRUCTURED_EXPLICIT ../mesh.uge
    MAX_CELLS_SHARING_A_VERTEX 70
  END

#=========================== regions ==========================================

  REGION all
    COORDINATES
      -1.d20 -1.d20 -1.d20
      1.d20 1.d20 1.d20
    /
  END

  REGION south
    FILE ../south.ex
  END

  REGION north
    FILE ../north.ex
  END

  REGION west
    FILE ../west.ex
  END

  REGION east
    FILE ../east.ex
  END

  {% for heatpump in heatpumps -%}
  {% for key, value in heatpump.items() -%}
  REGION {{ key }}_region
    COORDINATE {{ value.location[0] }} {{ value.location[1] }} {{ value.location[2] }}
  END
  {% endfor %}
  {%- endfor %}

#=========================== flow conditions ==================================

  FLOW_CONDITION initial
    TYPE
      LIQUID_PRESSURE HYDROSTATIC
      TEMPERATURE DIRICHLET
    /
    DATUM 200.d0 0.d0 85.d0
    GRADIENT
      LIQUID_PRESSURE {{ hydraulic_head.value.x }} {{ hydraulic_head.value.y }} {{ hydraulic_head.value.z }}
    /
    LIQUID_PRESSURE 101325.d0
    TEMPERATURE {{ temperature.value }} C
  /

  {% for heatpump in heatpumps -%}
  {% for key, value in heatpump.items() -%}
  FLOW_CONDITION {{ key }}_flow_condition !influx starting at day 72
    TYPE
      RATE SCALED_VOLUMETRIC_RATE VOLUME
      TEMPERATURE DIRICHLET
    END

    RATE LIST
      DATA_UNITS m^3/s
      TIME_UNITS {{ value.injection_rate.time_unit }}
      {%- for time_step, time_value in value.injection_rate.values.items() %}
      {{ time_step }}    {{ time_value }}
      {%- endfor %}
    END

    TEMPERATURE LIST
      DATA_UNITS C
      TIME_UNITS {{ value.injection_temp.time_unit }}
      {%- for time_step, time_value in value.injection_temp.values.items() %}
      {{ time_step }}    {{ time_value }}
      {%- endfor %}
    END
  END
  {% endfor %}
  {%- endfor %}

#=========================== condition couplers ===============================

# initial condition
  INITIAL_CONDITION
    FLOW_CONDITION initial
    REGION all
  /

# boundary conditions
  BOUNDARY_CONDITION
    FLOW_CONDITION initial
    REGION north
  /

  BOUNDARY_CONDITION
    FLOW_CONDITION initial
    REGION south
  /

  # boundary conditions
  BOUNDARY_CONDITION
    FLOW_CONDITION initial
    REGION west
  /

  BOUNDARY_CONDITION
    FLOW_CONDITION initial
    REGION east
  /

  {% for heatpump in heatpumps -%}
  {% for key, value in heatpump.items() -%}
  SOURCE_SINK {{ key }}_sink
    FLOW_CONDITION {{ key }}_flow_condition
    REGION {{ key }}_region
  END
  {% endfor %}
  {%- endfor %}

#=========================== stratigraphy couplers ============================

  STRATA
    REGION all
    MATERIAL gravel
  END

# same but different material for hps to get a map with the hp locations alias Material_ID
  {% for heatpump in heatpumps -%}
  {% for key, value in heatpump.items() -%}
  STRATA
    REGION {{ key }}_region
    MATERIAL {{ key }}_material
  END
  {% endfor %}
  {%- endfor %}

#=========================== output options ===================================

  OUTPUT
    SNAPSHOT_FILE
      TIMES y 0.1 1. 5.
      FORMAT HDF5 #VTK
      PRINT_COLUMN_IDS
      VARIABLES
        LIQUID_PRESSURE
        TEMPERATURE
        PERMEABILITY
      /
    /
    VELOCITY_AT_CENTER
  /

END_SUBSURFACE
